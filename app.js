label = [
  "愛",
  "委",
  "壱",
  "雲",
  "円",
  "王",
  "何",
  "火",
  "会",
  "階",
  "革",
  "官",
  "館",
  "希",
  "記",
  "休",
  "牛",
  "共",
  "曲",
  "句",
  "係",
  "芸",
  "券",
  "険",
  "古",
  "語",
  "口",
  "港",
  "合",
  "査",
  "菜",
  "刷",
  "蚕",
  "始",
  "死",
  "資",
  "治",
  "質",
  "弱",
  "需",
  "習",
  "出",
  "暑",
  "小",
  "章",
  "状",
  "深",
  "図",
  "政",
  "製",
  "責",
  "舌",
  "選",
  "倉",
  "増",
  "属",
  "多",
  "隊",
  "短",
  "竹",
  "貯",
  "直",
  "提",
  "転",
  "土",
  "等",
  "童",
  "内",
  "熱",
  "馬",
  "畑",
  "番",
  "美",
  "評",
  "布",
  "福",
  "弁",
  "法",
  "毎",
  "名",
  "目",
  "輸",
  "容",
  "浴",
  "略",
  "縁",
  "列",
  "話",
  "悪",
  "意",
  "印",
  "営",
  "園",
  "黄",
  "価",
  "花",
  "解",
  "貝",
  "学",
  "幹",
  "岸",
  "旗",
  "貴",
  "宮",
  "去",
  "協",
  "極",
  "区",
  "兄",
  "欠",
  "建",
  "験",
  "固",
  "誤",
  "向",
  "皇",
  "告",
  "再",
  "際",
  "察",
  "賛",
  "姉",
  "氏",
  "歯",
  "示",
  "実",
  "主",
  "収",
  "衆",
  "術",
  "書",
  "少",
  "証",
  "植",
  "申",
  "推",
  "整",
  "西",
  "赤",
  "先",
  "銭",
  "想",
  "蔵",
  "族",
  "太",
  "代",
  "団",
  "茶",
  "丁",
  "賃",
  "程",
  "点",
  "党",
  "答",
  "道",
  "南",
  "年",
  "拝",
  "八",
  "否",
  "鼻",
  "病",
  "府",
  "複",
  "陛",
  "保",
  "豊",
  "末",
  "命",
  "問",
  "勇",
  "曜",
  "来",
  "流",
  "林",
  "練",
  "圧",
  "易",
  "員",
  "栄",
  "延",
  "億",
  "加",
  "荷",
  "回",
  "外",
  "楽",
  "感",
  "眼",
  "期",
  "起",
  "急",
  "居",
  "境",
  "玉",
  "苦",
  "型",
  "決",
  "憲",
  "元",
  "己",
  "護",
  "后",
  "耕",
  "国",
  "最",
  "在",
  "殺",
  "酸",
  "子",
  "私",
  "事",
  "耳",
  "舎",
  "取",
  "周",
  "週",
  "述",
  "諸",
  "承",
  "象",
  "織",
  "真",
  "水",
  "星",
  "誠",
  "切",
  "千",
  "前",
  "早",
  "造",
  "続",
  "打",
  "台",
  "断",
  "着",
  "帳",
  "追",
  "敵",
  "伝",
  "冬",
  "統",
  "銅",
  "難",
  "念",
  "敗",
  "発",
  "悲",
  "必",
  "秒",
  "父",
  "仏",
  "米",
  "歩",
  "暴",
  "万",
  "明",
  "門",
  "友",
  "様",
  "落",
  "留",
  "臨",
  "連",
  "安",
  "異",
  "因",
  "永",
  "演",
  "屋",
  "可",
  "課",
  "快",
  "害",
  "額",
  "慣",
  "岩",
  "機",
  "技",
  "救",
  "挙",
  "強",
  "勤",
  "具",
  "形",
  "潔",
  "検",
  "原",
  "庫",
  "交",
  "孝",
  "考",
  "穀",
  "妻",
  "材",
  "雑",
  "残",
  "市",
  "糸",
  "似",
  "自",
  "写",
  "守",
  "宗",
  "集",
  "春",
  "助",
  "招",
  "賞",
  "職",
  "神",
  "数",
  "晴",
  "青",
  "接",
  "宣",
  "善",
  "争",
  "側",
  "卒",
  "体",
  "大",
  "男",
  "中",
  "張",
  "通",
  "的",
  "田",
  "刀",
  "討",
  "得",
  "二",
  "燃",
  "配",
  "判",
  "比",
  "筆",
  "品",
  "負",
  "物",
  "別",
  "補",
  "望",
  "満",
  "盟",
  "夜",
  "有",
  "洋",
  "利",
  "旅",
  "輪",
  "路",
  "暗",
  "移",
  "引",
  "泳",
  "遠",
  "恩",
  "夏",
  "貨",
  "改",
  "各",
  "活",
  "歓",
  "顔",
  "帰",
  "疑",
  "求",
  "許",
  "教",
  "均",
  "空",
  "敬",
  "結",
  "権",
  "厳",
  "戸",
  "候",
  "工(漢字)",
  "航",
  "黒",
  "才",
  "罪",
  "三",
  "仕",
  "師",
  "紙",
  "児",
  "辞",
  "社",
  "手",
  "就",
  "住",
  "準",
  "女",
  "昭",
  "上",
  "色",
  "臣",
  "世",
  "正",
  "静",
  "折",
  "専",
  "然",
  "相",
  "則",
  "存",
  "対",
  "第",
  "談",
  "忠",
  "朝",
  "低",
  "適",
  "電",
  "島",
  "頭",
  "徳",
  "弐",
  "納",
  "倍",
  "半",
  "皮",
  "百",
  "貧",
  "武",
  "分",
  "変",
  "墓",
  "貿",
  "味",
  "迷",
  "野",
  "由",
  "用",
  "理",
  "両",
  "類",
  "労",
  "案",
  "胃",
  "飲",
  "英",
  "塩",
  "温",
  "家",
  "過",
  "械",
  "拡",
  "株",
  "漢",
  "願",
  "気",
  "義",
  "球",
  "漁",
  "橋",
  "禁",
  "君",
  "景",
  "血",
  "犬",
  "減",
  "故",
  "光",
  "幸",
  "行",
  "今",
  "採",
  "財",
  "参",
  "使",
  "志",
  "至",
  "字",
  "式",
  "者",
  "種",
  "州",
  "十",
  "純",
  "序",
  "消",
  "乗",
  "食",
  "親",
  "是",
  "清",
  "税",
  "設",
  "川",
  "全",
  "総",
  "息",
  "孫",
  "帯",
  "題",
  "知",
  "昼",
  "町",
  "停",
  "鉄",
  "徒",
  "投",
  "働",
  "特",
  "肉",
  "能",
  "買",
  "反",
  "肥",
  "俵",
  "不",
  "部",
  "奮",
  "編",
  "母",
  "防",
  "未",
  "鳴",
  "役",
  "遊",
  "葉",
  "里",
  "料",
  "令",
  "老",
  "以",
  "遺",
  "院",
  "衛",
  "央",
  "音",
  "科",
  "我",
  "海",
  "格",
  "寒",
  "管",
  "喜",
  "汽",
  "議",
  "究",
  "魚",
  "興",
  "近",
  "訓",
  "系",
  "月",
  "研",
  "現",
  "湖",
  "公",
  "広",
  "講",
  "根",
  "済",
  "坂",
  "山",
  "司",
  "思",
  "視",
  "寺",
  "識",
  "謝",
  "酒",
  "修",
  "従",
  "順",
  "除",
  "焼",
  "場",
  "信",
  "身",
  "制",
  "生",
  "席",
  "節",
  "戦",
  "祖",
  "草",
  "測",
  "尊",
  "待",
  "達",
  "地",
  "柱",
  "腸",
  "定",
  "典",
  "登",
  "東",
  "動",
  "毒",
  "日",
  "夕",
  "入",
  "文",
  "支",
  "人",
  "一",
  "方",
  "木",
  "力",
];

let canvas = document.getElementById("canvas");
canvas.width = window.innerHeight * 0.6;
canvas.height = window.innerHeight * 0.6;
let context = canvas.getContext("2d");
context.fillStyle = "black";
context.fillRect(0, 0, canvas.width, canvas.height);
let restore_array = [];
let start_index = -1;
let stroke_color = "white";
let stroke_width = "10";
let is_drawing = false;

let model;
let predictions;
let imageData;

loadModel();

async function loadModel() {
  model = await tf.loadLayersModel("tfjs_file/model.json");
}

function change_color(element) {
  stroke_color = element.style.background;
}

function change_width(element) {
  stroke_width = element.innerHTML;
}

function start(event) {
  is_drawing = true;
  context.beginPath();
  context.moveTo(getX(event), getY(event));
  event.preventDefault();
}

function draw(event) {
  if (is_drawing) {
    context.lineTo(getX(event), getY(event));
    context.strokeStyle = stroke_color;
    context.lineWidth = stroke_width;
    context.lineCap = "round";
    context.lineJoin = "round";
    context.stroke();
  }
  event.preventDefault();
}

function stop(event) {
  if (is_drawing) {
    context.stroke();
    context.closePath();
    is_drawing = false;
  }
  event.preventDefault();
  restore_array.push(context.getImageData(0, 0, canvas.width, canvas.height));
  start_index += 1;
}

function getX(event) {
  if (event.pageX == undefined) {
    return event.targetTouches[0].pageX - canvas.offsetLeft;
  } else {
    return event.pageX - canvas.offsetLeft;
  }
}

function getY(event) {
  if (event.pageY == undefined) {
    return event.targetTouches[0].pageY - canvas.offsetTop;
  } else {
    return event.pageY - canvas.offsetTop;
  }
}

canvas.addEventListener("touchstart", start, false);
canvas.addEventListener("touchmove", draw, false);
canvas.addEventListener("touchend", stop, false);
canvas.addEventListener("mousedown", start, false);
canvas.addEventListener("mousemove", draw, false);
canvas.addEventListener("mouseup", stop, false);
canvas.addEventListener("mouseout", stop, false);

function Restore() {
  if (start_index <= 0) {
    Clear();
  } else {
    start_index += -1;
    restore_array.pop();
    if (event.type != "mouseout") {
      context.putImageData(restore_array[start_index], 0, 0);
    }
  }
}

function Clear() {
  context.fillStyle = "white";
  context.clearRect(0, 0, canvas.width, canvas.height);
  context.fillRect(0, 0, canvas.width, canvas.height);
  restore_array = [];
  start_index = -1;
}

function Recognize() {
  //let image = document.getElementById("image");

  //context.drawImage(image, 0, 0);

  imageData = context.getImageData(
    0,
    0,
    window.innerHeight * 0.6,
    window.innerHeight * 0.6
  );

  predict(imageData).then(alert);
  console.log(predictions);
  console.log(label[argMax(predictions)]);
}

function argMax(array) {
  return [].reduce.call(array, (m, c, i, arr) => (c > arr[m] ? i : m), 0);
}

async function predict(imageData) {
  await tf.tidy(() => {
    // Convert the canvas pixels to a Tensor of the matching shap
    let img = tf.browser.fromPixels(imageData, 3).resizeBilinear([64, 64]);
    img = tf.cast(img, "float32");
    rgb_weights = [0.2989, 0.587, 0.114];
    img = tf.mul(img, rgb_weights);
    img = tf.sum(img, (axis = -1));
    img = tf.expandDims(img, (axis = -1));
    img = img.reshape([1, 64, 64, 1]);
    img = tf.cast(img, "float32").div(tf.scalar(255));
    // Make and format the predications
    const output = model.predict(img);

    // Save predictions on the component
    predictions = Array.from(output.dataSync());
  });
}

function Download() {
  let canvasUrl = canvas.toDataURL("image/jpeg", 0.5);
  console.log(canvasUrl);
  const createEl = document.createElement("a");
  createEl.href = canvasUrl;
  createEl.download = "download-this-canvas";
  createEl.click();
  createEl.remove();
}
